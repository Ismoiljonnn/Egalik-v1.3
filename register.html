<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register</title>
<link rel="icon" type="image/png" href="Group 16.png">
<link rel="stylesheet" href="register.css">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
    <form id="regForm" action="#">
        <h1>Ro'yhatdan o'tish</h1>

        <div class="input-box">
            <input type="text" name="username" placeholder="Username" required>
            <i class='bx bx-user'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="password" placeholder="Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="repeat" placeholder="Repeat Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <button type="submit" id="regBtn" class="btn">ro'yhatdan o'tish</button>

        <div class="register-link">
            <p>You already have an account? <a href="login.html">Login</a></p>
        </div>
    </form>
</div>

<script>
const API_BASE = "https://egalik-api-v01.onrender.com/"; // Server URL

const form = document.getElementById("regForm");
const btn = document.getElementById("regBtn");

// Boshlanishida tugmani o'chirib turamiz
btn.disabled = true;

// Tugmani faqat form valid bo'lsa faollashtirish
form.addEventListener("input", () => {
    btn.disabled = !form.checkValidity();
});

// Form submit
form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // 1. Tugmani bloklaymiz
    btn.disabled = true;
    btn.innerText = "Yuborilmoqda...";

    // 2. Ma'lumotlarni yig'ish
    const formData = new FormData(form);
    
    // .trim() bu juda muhim - foydalanuvchi bilmasdan probel qo'shib qo'ysa tozalaydi
    const username = formData.get("username").trim();
    const password = formData.get("password").trim();
    const repeat = formData.get("repeat").trim();

    // Frontend password tekshiruvi
    if (password !== repeat) {
        alert("Parollar mos kelmadi!");
        btn.disabled = false;
        btn.innerText = "Ro'yhatdan o'tish";
        return;
    }

    // Backend kutgan format (Email yo'q)
    const payload = {
        username: username,
        password: password,
        password2: repeat 
    };

    try {
        // 3. So'rov yuborish
        const res = await fetch(API_BASE + "auth/register/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        // Javobni o'qish
        const data = await res.json().catch(() => ({}));

        if (res.ok) {
            alert("Muvaffaqiyatli! \nEndi login sahifasiga o'tib, profilingizga kiring.");
            window.location.href = "login.html";
        } else {
            // 4. Xatolarni chiqarish
            let errorMsg = "Xatolik yuz berdi:\n";

            if (data.username) errorMsg += "- Username: " + data.username.join(", ") + "\n";
            if (data.password) errorMsg += "- Parol: " + data.password.join(", ") + "\n";
            if (data.detail) errorMsg += "- " + data.detail + "\n";
            
            // Agar aniq xato topilmasa to'liq jsonni chiqaramiz
            if (errorMsg === "Xatolik yuz berdi:\n") {
                errorMsg += JSON.stringify(data);
            }

            alert(errorMsg);
            
            btn.disabled = false;
            btn.innerText = "Ro'yhatdan o'tish";
        }

    } catch (err) {
        console.error("Register Error:", err);
        alert("Server bilan bogâ€˜lanishda xato. Internetni tekshiring.");
        
        btn.disabled = false;
        btn.innerText = "Ro'yhatdan o'tish";
    }
});
</script>
</body>
</html>
