<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<link rel="icon" type="image/png" href="Group 16.png">
<link rel="stylesheet" href="login.css">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
    <form id="loginForm" action="#">
        <h1>Kirish</h1>

        <div class="input-box">
            <input type="text" name="username" placeholder="Username" required>
            <i class='bx bx-user'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="password" placeholder="Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <!-- <div class="remember-forgot">
            <label><input type="checkbox"> Remember me</label>
            <a href="#">Forgot password?</a>
        </div> -->

        <button id="loginBtn" type="submit" class="btn">Login</button>

        <div class="register-link">
            <p>Don't have an account? <a href="register.html">Register</a></p>
        </div>
    </form>
</div>

<script>
    const API_BASE = "https://egalik-api-v01.onrender.com/";
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("loginBtn");
    
    // Boshlanishida tugmani o'chirib turamiz
    btn.disabled = true;

    // Inputlar o'zgarganda validatsiyani tekshirish
    form.addEventListener("input", () => {
        btn.disabled = !form.checkValidity();
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Tugmani bosib bo'lmaydigan qilib turamiz
        btn.disabled = true;
        btn.innerText = "Kirilmoqda...";

        const username = form.elements["username"].value;
        const password = form.elements["password"].value;

        try {
            const res = await fetch(API_BASE + "auth/login/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            });

            // JSON o'qishda xato bo'lsa (masalan server 500 qaytarsa), bo'sh obyekt olamiz
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
                // Tokenni tekshiramiz
                const token = data.access || data.token || data.key; 

                if (token) {
                    localStorage.setItem("accessToken", token);
                    localStorage.setItem("username", username);
                    
                    if (data.refresh) {
                        localStorage.setItem("refreshToken", data.refresh);
                    }

                    // Muvaffaqiyatli o'tish
                    window.location.replace("index.html");
                } else {
                    alert("Xatolik: Server token qaytarmadi.");
                    btn.disabled = false;
                    btn.innerText = "Kirish";
                }
            } else {
                // Xatolikni chiroyli chiqarish
                let errorMsg = "Login yoki parol xato!";
                
                if (data.detail) errorMsg = data.detail;
                else if (data.message) errorMsg = data.message;
                else if (data.non_field_errors) errorMsg = data.non_field_errors[0];

                alert(errorMsg);
                
                btn.disabled = false;
                btn.innerText = "Kirish";
            }
        } catch (err) {
            console.error("Login Error:", err);
            alert("Serverga ulanishda xatolik yuz berdi. Internetni tekshiring.");
            btn.disabled = false;
            btn.innerText = "Kirish";
        }
    });
</script>
</body>
</html>
