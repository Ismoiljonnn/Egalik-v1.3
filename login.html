<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register</title>
<link rel="icon" type="image/png" href="Group 16.png">
<link rel="stylesheet" href="register.css">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
    <form id="regForm" action="#">
        <h1>Ro'yhatdan o'tish</h1>

        <div class="input-box">
            <input type="text" name="username" placeholder="Yangi Username o'ylab toping" required>
            <i class='bx bx-user'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="password" placeholder="Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="repeat" placeholder="Repeat Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <button type="submit" id="regBtn" class="btn">ro'yhatdan o'tish</button>

        <div class="register-link">
            <p>You already have an account? <a href="login.html">Login</a></p>
        </div>
    </form>
</div>

<script>
const API_BASE = "https://egalik-api-v01.onrender.com/"; 

const form = document.getElementById("regForm");
const btn = document.getElementById("regBtn");

btn.disabled = true;

form.addEventListener("input", () => {
    btn.disabled = !form.checkValidity();
});

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    btn.innerText = "Yuborilmoqda...";

    const formData = new FormData(form);
    const username = formData.get("username").trim();
    const password = formData.get("password").trim();
    const repeat = formData.get("repeat").trim();

    if (password !== repeat) {
        alert("Parollar mos kelmadi!");
        btn.disabled = false;
        btn.innerText = "Ro'yhatdan o'tish";
        return;
    }

    // --- SERVERNI ALDASH (Soxta Email) ---
    // Server email talab qilgani uchun, biz username asosida email yasab yuboramiz.
    const fakeEmail = `${username}@egalik.uz`;

    const payload = {
        username: username,
        password: password,
        password2: repeat,
        email: fakeEmail // <-- Mana shu narsa registratsiyani qutqarib qoladi
    };

    try {
        const res = await fetch(API_BASE + "auth/register/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
            alert(`Muvaffaqiyatli! âœ…\n\nLogin: ${username}\nParol: ${password}\n\nEndi bemalol kirishingiz mumkin!`);
            window.location.href = "login.html";
        } else {
            let errorMsg = "Xatolik:\n";
            if (data.username) errorMsg += "Username: " + data.username.join(" ") + "\n";
            if (data.password) errorMsg += "Parol: " + data.password.join(" ") + "\n";
            
            // Agar bo'sh xato kelsa (image_db6b39.png dagi kabi)
            if (Object.keys(data).length === 0) {
                errorMsg += "Server ichki xatosi (500). Iltimos, boshqa Username sinab ko'ring.";
            } else {
                errorMsg += JSON.stringify(data);
            }
            alert(errorMsg);
            btn.disabled = false;
            btn.innerText = "Ro'yhatdan o'tish";
        }

    } catch (err) {
        alert("Internet xatosi: " + err.message);
        btn.disabled = false;
        btn.innerText = "Ro'yhatdan o'tish";
    }
});
</script>
</body>
</html>
