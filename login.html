<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<link rel="icon" type="image/png" href="Group 16.png">
<link rel="stylesheet" href="login.css">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
    <form id="loginForm" action="#">
        <h1>Kirish</h1>

        <div class="input-box">
            <input type="text" name="username" placeholder="Username" required>
            <i class='bx bx-user'></i> 
        </div>

        <div class="input-box">
            <input type="password" name="password" placeholder="Password" required>
            <i class='bx bx-lock'></i> 
        </div>

        <button id="loginBtn" type="submit" class="btn">Login</button>

        <div class="register-link">
            <p>Don't have an account? <a href="register.html">Register</a></p>
        </div>
    </form>
</div>

<script>
    const API_BASE = "https://egalik-api-v01.onrender.com/";
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("loginBtn");
    
    // Boshlanishida tugmani o'chirib turamiz
    btn.disabled = true;

    // Inputlar o'zgarganda validatsiyani tekshirish
    form.addEventListener("input", () => {
        btn.disabled = !form.checkValidity();
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 1. Tugmani bloklaymiz
        btn.disabled = true;
        btn.innerText = "Tekshirilmoqda...";

        // 2. Ma'lumotlarni tozalab olamiz (ENG MUHIM QISM)
        // .trim() bu probellarni olib tashlaydi
        const username = form.elements["username"].value.trim();
        const password = form.elements["password"].value.trim();

        try {
            console.log("Login so'rovi yuborilmoqda:", username);

            // 3. Serverga so'rov yuborish
            const res = await fetch(API_BASE + "auth/login/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                    // Eslatma: 'Authorization' headeri login paytida kerak emas
                },
                body: JSON.stringify({ username, password })
            });

            // 4. Javobni o'qish
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
                // Backenddan keladigan token har xil bo'lishi mumkin, hammasini tekshiramiz
                const token = data.access || data.token || data.key; 

                if (token) {
                    // Tokenni saqlaymiz
                    localStorage.setItem("accessToken", token);
                    localStorage.setItem("username", username);
                    
                    if (data.refresh) {
                        localStorage.setItem("refreshToken", data.refresh);
                    }

                    // Muvaffaqiyatli o'tish
                    // alert("Xush kelibsiz!"); // Ixtiyoriy
                    window.location.replace("index.html");
                } else {
                    alert("Xatolik: Server OK dedi, lekin Token bermadi!\nJavob: " + JSON.stringify(data));
                    btn.disabled = false;
                    btn.innerText = "Login";
                }
            } else {
                // XATOLIKNI ANIQLASH
                let errorMsg = "Login yoki parol xato!";
                
                // Serverdan kelgan aniq xabarni olishga harakat qilamiz
                if (data.detail) errorMsg = data.detail;
                else if (data.message) errorMsg = data.message;
                else if (data.non_field_errors) errorMsg = data.non_field_errors[0];
                else if (Object.keys(data).length > 0) errorMsg = JSON.stringify(data);

                alert(errorMsg);
                
                // Konsolga ham chiqaramiz (F12 bosib ko'rish uchun)
                console.error("Login xatosi:", data);
                
                btn.disabled = false;
                btn.innerText = "Login";
            }
        } catch (err) {
            console.error("Ulanish xatosi:", err);
            alert("Internet yoki Server bilan aloqa yo'q.\nIltimos, internetingizni tekshiring.");
            btn.disabled = false;
            btn.innerText = "Login";
        }
    });
</script>
</body>
</html>
